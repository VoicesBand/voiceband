<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Voices - STL's Premier Classic Band</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="images/logoGTO.jpg" type="image/jpeg">

  <!-- Modern cards for About + Gallery, compact booking, subtle newsletter, navbar offset, centered nav + right socials -->
  <style>
    /* --- Modern ‚Äúcard‚Äù look (match site bg, no gradients) --- */
    .card-dark{
      background:#222;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:18px;
    }
    .card-dark h2{ margin:0 0 10px 0; }
    .card-dark .sub{ margin:0 0 12px 0; color:#a7b0c0; }

    /* Nudge About down so it doesn't butt up against the banner */
    #about{ margin-top: clamp(12px, 2vw, 28px); }

    /* --- Ensure anchor jumps land below sticky header --- */
    #about, #live-upcoming, #gallery, #booking, #newsletter, #socials-section{
      scroll-margin-top: calc(var(--sticky-header, 0px) + 12px);
    }

    /* =========================
       NAV: centered tabs + right socials
       ========================= */
    .site-header { width:100%; }
    .nav-shell{
      display:flex; align-items:center; gap:12px;
      width:100%;
    }
    .nav-left{ flex:0 0 auto; display:flex; align-items:center; }
    .nav-center{ flex:1 1 auto; display:flex; justify-content:center; }
    .nav-right{ flex:0 0 auto; display:flex; justify-content:flex-end; min-width:140px; }

    /* Your existing nav buttons container */
    .nav-bar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    /* Small square social logos (fixed sizing & centering) */
    .nav-socials{
      display:flex; gap:8px;
    }
    .nav-socials a{
      width:28px; height:28px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      border-radius:6px;
      text-decoration:none;
      transition:background .15s ease, border-color .15s ease, transform .06s ease;
    }
    .nav-socials a:hover{ background:rgba(255,255,255,.1); border-color:rgba(125,166,255,.35); transform:translateY(-1px); }
    .nav-socials svg{ width:16px; height:16px; display:block; }

    /* --- Upcoming Shows --- */
    .shows{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px 14px;
      display:flex; flex-direction:column; gap:8px;
    }
    .show-track{width:100%;}
    .show-card{display:none; align-items:flex-start; gap:12px; padding:6px 2px; opacity:0; transform:translateY(4px); transition:opacity .2s ease, transform .2s ease;}
    .show-card.active{display:flex; opacity:1; transform:translateY(0)}
    .tag{font-size:.78rem; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); white-space:nowrap;}
    .show-text{line-height:1.25; font-size:.95rem; display:flex; flex-direction:column; gap:4px;}
    .show-text .where{display:block;}
    .show-text .time{opacity:.9; font-size:.92em;}
    .copy-btn{ margin-left:auto; padding:0 12px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.04); color:inherit; cursor:pointer;}
    .copy-btn:hover,.copy-btn:focus-visible{ background:rgba(255,255,255,.08); border-color:rgba(125,166,255,.35); outline:none; }
    .dots{display:flex; gap:6px; margin-top:4px;}
    .dot{width:6px; height:6px; border-radius:50%; background:rgba(255,255,255,.28);}
    .dot.active{background:#fff}
    .status{font-size:.85rem; opacity:.8;}

    /* --- Media Gallery: exactly two videos side-by-side + centered button --- */
    .video-grid{ display:grid; gap:12px; grid-template-columns:repeat(2, minmax(0,1fr)); }
    @media (max-width: 720px){ .video-grid{ grid-template-columns:1fr; } }
    #gallery .btn-row{ text-align:center; margin-top:12px; }
    #gallery .btn-row .btn{ display:inline-block; }

    /* --- Compact modern booking form --- */
    #booking .form-modern{ max-width:840px; margin:0 auto; display:flex; flex-direction:column; gap:12px; position:relative; }
    #booking .row{ display:grid; gap:12px; grid-template-columns:repeat(2, minmax(0,1fr)); }
    @media (max-width:720px){ #booking .row{ grid-template-columns:1fr; } }
    #booking input, #booking textarea{
      width:100%;
      appearance:none;
      background:#151515;
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      padding:10px 12px;
      font-size:0.95rem; line-height:1.2;
      color:#e9ecf3;
    }
    #booking textarea{ min-height:110px; resize:vertical; }
    #booking input::placeholder, #booking textarea::placeholder{ color:#98a6bb; }
    #booking input:focus, #booking textarea:focus{
      outline:none;
      border-color:rgba(0,191,255,.6);
      box-shadow:0 0 0 2px rgba(0,191,255,.25);
    }
    #booking .actions{ display:flex; justify-content:center; }
    #booking .btn-submit{
      padding:9px 16px;
      border-radius:10px;
      border:1px solid rgba(0,191,255,.7);
      background:#00bfff;
      color:#071218;
      font-weight:700;
      cursor:pointer;
    }
    #booking .btn-submit:hover{ filter:brightness(1.05); }

    /* --- Subtle / non-chalant newsletter --- */
    #newsletter{ text-align:center; }
    #newsletter h2{ margin-bottom:8px; }
    #newsletter .micro{
      display:inline-flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:10px; padding:6px 6px;
    }
    #newsletter input[type="email"]{
      width: min(320px, 70vw);
      background:transparent; border:none; outline:none; color:#e9ecf3;
      padding:8px 10px; font-size:.95rem;
    }
    #newsletter input::placeholder{ color:#98a6bb; }
    #newsletter button{
      border:1px solid rgba(0,191,255,.45);
      background:transparent; color:#d9f3ff;
      padding:8px 10px; border-radius:8px; font-weight:600; cursor:pointer;
    }
    #newsletter button:hover{ background:rgba(0,191,255,.12); }

    /* ===== Mobile nav: keep buttons in one row, allow horizontal scroll ===== */
    @media (max-width: 720px){
      .nav-center { flex: 1 1 auto; min-width: 0; }
      .nav-scroll {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      .nav-scroll::-webkit-scrollbar { display: none; }
      .nav-bar { flex-wrap: nowrap; gap: 6px; }
      .nav-bar button, .nav-bar .admin-link { flex: 0 0 auto; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="nav-shell">
      <div class="nav-left">
        <div class="logo">
          <img id="logo-img" src="images/logoGTO.jpg" alt="Voices Logo" />
        </div>
      </div>

      <div class="nav-center">
        <nav class="nav-scroll">
          <div class="nav-bar">
            <button onclick="scrollToSection('about')">about</button>
            <button onclick="scrollToSection('live-upcoming')">shows</button>
            <button onclick="scrollToSection('gallery')">gallery</button>
            <button onclick="scrollToSection('booking')">booking</button>
            <a href="admin.html" class="admin-link">Admin</a>
          </div>
        </nav>
      </div>

      <div class="nav-right">
        <!-- Right-aligned socials (small square logos) -->
        <div class="nav-socials" aria-label="Social links">
          <a href="https://www.facebook.com/voicessing/" target="_blank" rel="noopener noreferrer" title="Facebook" aria-label="Facebook">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14 9h3V6h-3a3 3 0 00-3 3v2H8v3h3v6h3v-6h2.5l.5-3H14V9a1 1 0 011-1z" fill="#cfe0ff"/></svg>
          </a>
          <a href="https://youtube.com/@VoicesSTL" target="_blank" rel="noopener noreferrer" title="YouTube" aria-label="YouTube">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <rect x="2" y="6" width="20" height="12" rx="3" fill="#ff6b6b" opacity=".9"></rect>
              <path d="M10 9.5v5l5-2.5-5-2.5z" fill="#fff"></path>
            </svg>
          </a>
          <a href="https://www.tiktok.com/@voicesbandofficial" target="_blank" rel="noopener noreferrer" title="TikTok" aria-label="TikTok">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M15 3v3.4a5.6 5.6 0 004 1.6V12a9.1 9.1 0 01-4-1.1v4.1A5.9 5.9 0 119 9.2v3.3a2.6 2.6 0 102.6 2.6V3h3.4z" fill="#d9d4ff"/></svg>
          </a>
          <a href="https://www.instagram.com/voicesmusicofficial/" target="_blank" rel="noopener noreferrer" title="Instagram" aria-label="Instagram">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <rect x="3" y="3" width="18" height="18" rx="5" stroke="#cfe0ff" stroke-width="2"></rect>
              <circle cx="12" cy="12" r="4.2" stroke="#cfe0ff" stroke-width="2"></circle>
              <circle cx="17.4" cy="6.6" r="1.2" fill="#cfe0ff"></circle>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- HERO / BANNER -->
  <header class="hero">
    <img src="images/banner.jpg" alt="Voices Band Banner" />
  </header>

  <!-- ABOUT -->
  <section id="about" class="card-dark">
    <h2>üé§ Voices</h2>
    <p id="about-text" class="sub"></p>
  </section>

  <!-- IMAGE CAROUSEL -->
  <div id="carousel">
    <img id="carousel-img" src="images/1.JPG" alt="Band Carousel" />
  </div>

  <!-- UPCOMING SHOWS -->
  <section id="live-upcoming">
    <h3 style="color:#00bfff;">Live Upcoming Shows</h3>
    <section class="shows" id="shows" aria-live="polite">
      <div class="show-track" id="showTrack"></div>
      <div class="dots" id="dots"></div>
      <div class="status" id="showsStatus">Loading upcoming shows‚Ä¶</div>
    </section>
  </section>

  <!-- MEDIA GALLERY -->
  <section id="gallery" class="card-dark">
    <h2>Media Gallery</h2>
    <div class="video-grid" id="video-grid"></div>
    <div class="btn-row">
      <a href="https://www.youtube.com/@VoicesSTL" target="_blank" class="btn" rel="noopener noreferrer">More Videos</a>
    </div>
  </section>

  <!-- BOOKING (with anti-bot fields matching GAS) -->
  <section id="booking">
    <h2>Book Voices</h2>
    <form id="booking-form" class="form-modern" autocomplete="off">
      <!-- Honeypot (bots fill it; humans never see it) -->
      <div style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;">
        <label>Leave this field blank
          <input type="text" name="hp_url" tabindex="-1" autocomplete="off">
        </label>
      </div>
      <!-- Anti-bot metadata expected by GAS -->
      <input type="hidden" name="form_started_ms" id="bk-started" value="">
      <input type="hidden" name="nonce" id="bk-nonce" value="">
      <!-- If you enable reCAPTCHA later, add <input type="hidden" name="recaptcha" id="bk-recaptcha"> -->

      <div class="row">
        <input type="text" name="name" placeholder="Your Name" required />
        <input type="email" name="email" placeholder="Your Email" required />
      </div>
      <div class="row">
        <input type="text" name="date" placeholder="Requested Date" required />
        <input type="text" name="location" placeholder="Event Location" required />
      </div>
      <textarea name="message" placeholder="Additional Info or Questions" maxlength="1000"></textarea>
      <div class="actions">
        <button type="submit" class="btn-submit">Submit Booking</button>
      </div>
    </form>
  </section>

  <!-- NEWSLETTER -->
  <section id="newsletter">
    <h2>Newsletter</h2>
    <div class="micro">
      <input id="newsletter-email" type="email" placeholder="you@example.com" autocomplete="email" />
      <button id="newsletter-btn" type="button">Sign up</button>
    </div>
  </section>

  <!-- SCRIPTS -->
  <script>
    /* ---------- Sticky-header aware scrolling ---------- */
    function setStickyHeaderVar(){
      const h = document.querySelector('.site-header')?.getBoundingClientRect().height || 0;
      document.documentElement.style.setProperty('--sticky-header', `${h}px`);
    }
    function scrollToSection(id){
      const el = document.getElementById(id);
      if (!el) return;
      const header = document.querySelector('.site-header');
      const offset = (header?.getBoundingClientRect().height || 0) + 12;
      const y = Math.max(0, el.getBoundingClientRect().top + window.pageYOffset - offset);
      window.scrollTo({ top: y, behavior: 'smooth' });
    }
    window.addEventListener('resize', setStickyHeaderVar);

    const staticData = {
      logoURL: "images/logoGTO.jpg",
      aboutText: `Formerly known as GTO (Good Time Oldies), Voices is a seasoned 4-piece band
      performing around the STL Metro area. Blending live instruments and synthetic backing tracks,
      they cover classic hits from the 60s through the 2000s ‚Äî full of energy, sound, and nostalgia.

      Left (Pat Downs), middle Left (Billy Presnell), Middle right (Dennis Gillam), Right (Jesse Miller).`,
      videoUrls: [
        "https://www.youtube.com/embed/ycCKV5uYKSE",
        "https://www.youtube.com/embed/O-PhaZvzlYw",
        "https://www.youtube.com/embed/-oo8J8FeD-I",
        "https://www.youtube.com/embed/bl5HUp8BnlE"
      ],
      socials: [
        { platform: "Facebook", url: "https://www.facebook.com/voicessing/" },
        { platform: "YouTube",  url: "https://youtube.com/@VoicesSTL" },
        { platform: "TikTok",   url: "https://www.tiktok.com/@voicesbandofficial" },
        { platform: "Instagram",url: "https://www.instagram.com/voicesmusicofficial/" }
      ]
    };

    function formatDateString(dateStr) {
      if (!dateStr) return '';
      const dateObj = new Date(dateStr);
      if (isNaN(dateObj.getTime())) return '';
      const monthNames = ["JAN.", "FEB.", "MAR.", "APR.", "MAY", "JUN.", "JUL.", "AUG.", "SEP.", "OCT.", "NOV.", "DEC."];
      const day = dateObj.getDate();
      function ordinalSuffix(n) {
        if (n > 3 && n < 21) return n + "th";
        switch (n % 10) { case 1: return n + "st"; case 2: return n + "nd"; case 3: return n + "rd"; default: return n + "th"; }
      }
      return `${monthNames[dateObj.getMonth()]} ${ordinalSuffix(day)}`;
    }
    function formatTimeForDisplay(timeValue) {
      if (!timeValue) return "Time TBD";
      if (typeof timeValue === 'string') {
        const parsedDate = new Date(timeValue);
        if (!isNaN(parsedDate.getTime())) { timeValue = parsedDate; }
        else { const trimmed = timeValue.trim(); return trimmed.length > 0 ? trimmed : "Time TBD"; }
      }
      if (timeValue instanceof Date && !isNaN(timeValue.getTime())) {
        let hours = timeValue.getHours(), minutes = timeValue.getMinutes();
        const ampm = hours >= 12 ? "PM" : "AM";
        hours = hours % 12; if (hours === 0) hours = 12;
        const minutesStr = minutes === 0 ? "" : ":" + (minutes < 10 ? "0" + minutes : minutes);
        return `${hours}${minutesStr}${ampm}`;
      }
      return "Time TBD";
    }

    function updatePage() {
      document.getElementById('logo-img').src = staticData.logoURL;
      document.getElementById('about-text').textContent = staticData.aboutText;

      // Gallery (2-up via CSS)
      const videoGrid = document.getElementById('video-grid');
      videoGrid.innerHTML = '';
      staticData.videoUrls.forEach(url => {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.allowFullscreen = true;
        iframe.setAttribute('frameborder', '0');
        videoGrid.appendChild(iframe);
      });

      // Optional Socials section render ‚Äî only if #social-links exists
      const socialsWrap = document.getElementById('social-links');
      if (socialsWrap){
        socialsWrap.innerHTML = '';
        const icons = {
          Facebook: `<svg width="20" height="20" fill="#cfe0ff"><path d="M14 9h3V6h-3a3 3 0 00-3 3v2H8v3h3v6h3v-6h2.5l.5-3H14V9a1 1 0 011-1z"/></svg>`,
          YouTube:  `<svg width="20" height="20"><rect x="2" y="6" width="20" height="12" rx="3" fill="#ff6b6b"></rect><path d="M10 9.5v5l5-2.5-5-2.5z" fill="#fff"></path></svg>`,
          TikTok:   `<svg width="20" height="20" fill="#d9d4ff"><path d="M15 3v3.4a5.6 5.6 0 004 1.6V12a9.1 9.1 0 01-4-1.1v4.1A5.9 5.9 0 119 9.2v3.3a2.6 2.6 0 102.6 2.6V3h3.4z"/></svg>`,
          Instagram:`<svg width="20" height="20" stroke="#cfe0ff" fill="none" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="5"/><circle cx="12" cy="12" r="4.2"/><circle cx="17.4" cy="6.6" r="1.2" fill="#cfe0ff"/></svg>`
        };
        const grid = document.createElement('div');
        grid.className = 'socials-grid';
        (staticData.socials || []).forEach(({platform, url})=>{
          const a = document.createElement('a');
          a.className = 'social-btn';
          a.href = url; a.target="_blank"; a.rel="noopener noreferrer";
          a.innerHTML = `<span class="ico">${icons[platform]||''}</span><span>${platform}</span>`;
          grid.appendChild(a);
        });
        socialsWrap.appendChild(grid);
      }
    }

    /* ---------- Image Carousel ---------- */
    const carouselImages = [
      'images/1.JPG','images/2.JPG','images/3.JPG','images/4.JPG','images/5.JPG',
      'images/6.JPG','images/7.JPG','images/8.JPG','images/9.JPG','images/10.JPG','images/11.JPG','images/12.JPG','images/13.JPG','images/14.JPG','images/15.JPG','images/16.JPG'
    ];
    let currentImgIndex=0;
    function cycleCarousel() {
      const img = document.getElementById('carousel-img');
      currentImgIndex = (currentImgIndex + 1) % carouselImages.length;
      img.src = carouselImages[currentImgIndex];
    }

    /* ---------- Upcoming Shows ---------- */
    const webAppURL = "https://script.google.com/macros/s/AKfycbz92casEHmVvhw9Xc46Mv7cbm9USjWNusekHGQFSfLyxpOFdb5yGYhC8_KyNxZjiXIQZQ/exec";
    const POLL_MS = 15000;
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const today = new Date(); today.setHours(0,0,0,0);

    let showsEl, trackEl, dotsEl, statusEl;

    function normalize(raw){
      return (raw || []).map(s => ({
        date:    s.Date,
        time:    s.Time,
        title:   s.Location || "Show",
        city:    s.City || "",
        map:     s.Map || "",
        Location: s.Location || ""
      }))
      .filter(s => {
        if (!s.date) return false;
        const d = new Date(s.date); d.setHours(0,0,0,0);
        return d >= today;
      })
      .sort((a,b) => new Date(a.date) - new Date(b.date));
    }
    function tryAddressFromMap(mapUrl){
      try{
        if (!mapUrl) return "";
        const u = new URL(mapUrl);
        const q = u.searchParams.get('q'); if (q) return decodeURIComponent(q).replace(/\+/g,' ').trim();
        const query = u.searchParams.get('query'); if (query) return decodeURIComponent(query).replace(/\+/g,' ').trim();
        const path = decodeURIComponent(u.pathname);
        const m = path.match(/\/maps\/(?:place|search)\/([^/]+)/i);
        if (m && m[1]) return m[1].replace(/\+/g,' ').replace(/,/g, ', ').trim();
      }catch(e){}
      return "";
    }
    function buildAddressOnly(s){
      const addr = (s.Location && s.Location.trim()) || tryAddressFromMap(s.map);
      return addr || "";
    }
    function clipboardCopy(text){
      if (navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text);
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); } finally { document.body.removeChild(ta); }
      return Promise.resolve();
    }

    let cards = [], dots = [], idx = 0, rotateTimer = null, pollTimer = null, lastHash = "";
    function clearChildren(n){ while(n.firstChild) n.removeChild(n.firstChild); }
    function activate(i){ cards.forEach((c,j)=>c.classList.toggle('active', j===i)); dots.forEach((d,j)=>d.classList.toggle('active', j===i)); }
    function startRotate(){ if (prefersReduced || !cards.length) return; stopRotate(); rotateTimer=setInterval(()=>{ idx=(idx+1)%cards.length; activate(idx); },4000); }
    function stopRotate(){ if (rotateTimer){ clearInterval(rotateTimer); rotateTimer=null; } }

    function render(upcoming){
      const currentVenue = cards[idx]?.querySelector('.where strong')?.textContent || null;
      clearChildren(trackEl); clearChildren(dotsEl); cards=[]; dots=[];
      upcoming.forEach((s)=>{
        const card=document.createElement('div'); card.className='show-card';
        const tag=document.createElement('div'); tag.className='tag';
        tag.textContent=`${new Date(s.date).toLocaleDateString(undefined,{ weekday:'short' })} ‚Ä¢ ${formatDateString(s.date)}`;
        const text=document.createElement('div'); text.className='show-text';
        const where=document.createElement(s.map?'a':'span'); where.className='where';
        if (s.map){ where.href=s.map; where.target="_blank"; where.rel="noopener noreferrer"; }
        where.title = s.city ? `${s.title} ‚Äî ${s.city}` : s.title;
        where.innerHTML=`<strong>${s.title}</strong>${s.city ? ` ‚Äî ${s.city}` : ''}`;
        const time=document.createElement('div'); time.className='time'; time.textContent=formatTimeForDisplay(s.time);
        const copyBtn=document.createElement('button'); copyBtn.className='copy-btn'; copyBtn.type='button'; copyBtn.textContent='Copy';
        copyBtn.addEventListener('click', async ()=>{
          const a=buildAddressOnly(s);
          if (!a){ alert('No address available to copy for this event yet.'); return; }
          try { await clipboardCopy(a); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy',1200); }
          catch { alert('Could not copy. Long-press to copy the address manually:\n\n'+a); }
        });
        text.appendChild(where); text.appendChild(time);
        card.appendChild(tag); card.appendChild(text); card.appendChild(copyBtn);
        trackEl.appendChild(card);
        const dot=document.createElement('span'); dot.className='dot'; dotsEl.appendChild(dot);
        cards.push(card); dots.push(dot);
      });
      const newIndex = currentVenue ? cards.findIndex(c => c.querySelector('.where strong')?.textContent === currentVenue) : 0;
      idx = newIndex >= 0 ? newIndex : 0; activate(idx); startRotate();
    }

    async function fetchShows(){
      const res = await fetch(webAppURL + "?_=" + Date.now(), { cache: "no-store", mode: "cors" });
      if (!res.ok) throw new Error("Apps Script fetch failed: " + res.status);
      const data = await res.json(); return normalize(data);
    }
    async function refresh(){
      if (document.hidden) return;
      try{
        const upcoming = await fetchShows();
        const h = JSON.stringify(upcoming);
        if (h !== lastHash){
          lastHash = h;
          statusEl.textContent = upcoming.length ? "" : "No upcoming shows yet ‚Äî check back soon!";
          if (!upcoming.length){
            stopRotate();
            trackEl.innerHTML = `<div class="show-card active">
              <div class="tag">‚Äî ‚Ä¢ ‚Äî</div>
              <div class="show-text"><span class="where">No upcoming shows yet</span><div class="time"></div></div>
              <button class="copy-btn" type="button" disabled>Copy</button>
            </div>`;
            clearChildren(dotsEl); cards = Array.from(trackEl.children); dots = [];
          } else { render(upcoming); }
        }
      } catch(err){
        console.error("[Index] fetch shows error:", err);
        statusEl.textContent = "Couldn‚Äôt load shows. Check connection or Apps Script.";
      }
    }
    function startPoll(){ if (!pollTimer) pollTimer = setInterval(refresh, POLL_MS); }
    function stopPoll(){ if (pollTimer){ clearInterval(pollTimer); pollTimer = null; } }

    // Booking + Newsletter endpoints
    const scriptURL = webAppURL; // same Apps Script endpoint

    // ---------- Anti-bot: nonce + start time (matches your GAS) ----------
    let currentNonce = "";
    async function mintNonce(){
      try{
        const res = await fetch(scriptURL + "?action=nonce", { cache:"no-store", mode:"cors" });
        const j = await res.json();
        currentNonce = j && j.nonce ? j.nonce : "";
      }catch{ currentNonce = ""; }
    }

    window.onload=async ()=>{
      setStickyHeaderVar();
      updatePage();
      setInterval(cycleCarousel, 4000);

      if (location.hash) { setTimeout(() => scrollToSection(location.hash.slice(1)), 0); }

      // Shows init
      showsEl  = document.getElementById('shows');
      trackEl  = document.getElementById('showTrack');
      dotsEl   = document.getElementById('dots');
      statusEl = document.getElementById('showsStatus');

      (async function initShows(){
        await refresh();
        showsEl.addEventListener('mouseenter', stopRotate);
        showsEl.addEventListener('mouseleave', startRotate);
        showsEl.addEventListener('focusin',  stopRotate);
        showsEl.addEventListener('focusout', startRotate);

        // Swipe
        let x0=null;
        showsEl.addEventListener('touchstart', e=>{ x0=e.touches[0].clientX; }, {passive:true});
        showsEl.addEventListener('touchend', e=>{
          if (x0==null || !cards.length) return;
          const dx=e.changedTouches[0].clientX - x0;
          if (Math.abs(dx) > 30){ idx=(idx + (dx<0?1:-1) + cards.length) % cards.length; activate(idx); }
          x0=null;
        });

        // Keyboard
        showsEl.tabIndex=0;
        showsEl.addEventListener('keydown', e=>{
          if (!cards.length) return;
          if (e.key==='ArrowRight'){ idx=(idx+1)%cards.length; activate(idx); e.preventDefault(); }
          if (e.key==='ArrowLeft'){  idx=(idx-1+cards.length)%cards.length; activate(idx); e.preventDefault(); }
        });

        // Polling
        document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ stopPoll(); stopRotate(); } else { startPoll(); startRotate(); refresh(); } });
        startPoll();
      })();

      // Prepare anti-bot metadata
      await mintNonce();

      // Booking
      const form = document.getElementById("booking-form");
      const startedEl = document.getElementById("bk-started");
      const nonceEl   = document.getElementById("bk-nonce");
      startedEl.value = Date.now().toString();
      nonceEl.value   = currentNonce;

      function looksHumanName(s){ return /^[a-zA-Z .,'-]{2,60}$/.test((s||'').trim()); }
      function looksEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((s||'').trim()); }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(form);

        // client-side guardrails (server rechecks everything)
        const name = (fd.get("name")||"").trim();
        const email= (fd.get("email")||"").trim();
        if (!looksHumanName(name)) return alert("Please enter your real name.");
        if (!looksEmail(email))    return alert("Please enter a valid email.");

        // Make sure nonce is present
        if (!currentNonce){ await mintNonce(); nonceEl.value = currentNonce || ""; }
        const body = new URLSearchParams(fd);

        fetch(scriptURL, { method: "POST", body })
          .then(res => res.json())
          .then(async data => {
            if (data.result === "success") {
              alert("‚úÖ Booking submitted successfully!");
              form.reset();
              // rotate shields after each submit
              startedEl.value = Date.now().toString();
              await mintNonce(); nonceEl.value = currentNonce || "";
            } else {
              alert("‚ùå " + (data.message || "Submission rejected."));
              // refresh nonce on any error too
              await mintNonce(); nonceEl.value = currentNonce || "";
            }
          })
          .catch(async error => {
            console.error("Error sending booking:", error);
            alert("‚ùå Network or system error occurred.");
            await mintNonce(); nonceEl.value = currentNonce || "";
          });
      });

      // Newsletter
      const newsletterBtn  = document.getElementById("newsletter-btn");
      const newsletterInput= document.getElementById("newsletter-email");
      newsletterBtn.addEventListener("click", async () => {
        const email = (newsletterInput.value || "").trim();
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return alert("Please enter a valid email.");

        // Use same anti-bot metadata
        const startedMs = (startedEl.value && parseInt(startedEl.value,10)) || Date.now();
        if (!currentNonce){ await mintNonce(); nonceEl.value = currentNonce || ""; }

        const params = new URLSearchParams({
          email,
          newsletter: "true",
          // anti-bot fields:
          hp_url: "",                    // honeypot stays empty
          form_started_ms: String(startedMs),
          nonce: currentNonce
        });

        fetch(scriptURL, { method: "POST", body: params })
          .then(res => res.json())
          .then(async data => {
            if (data.result === "success") {
              alert("‚úÖ Thanks for signing up! Check your email for confirmation.");
              newsletterInput.value = "";
              startedEl.value = Date.now().toString();
              await mintNonce(); nonceEl.value = currentNonce || "";
            } else {
              alert("‚ùå " + (data.message || "Couldn‚Äôt sign you up."));
              await mintNonce(); nonceEl.value = currentNonce || "";
            }
          })
          .catch(async err => {
            console.error(err);
            alert("‚ùå Failed to sign up.");
            await mintNonce(); nonceEl.value = currentNonce || "";
          });
      });
      // Enter key submits newsletter
      newsletterInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); newsletterBtn.click(); }});
    };
  </script>
</body>
</html>
